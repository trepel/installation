---
-
  name: Check master-config has been modified by the installer
  shell: "cat {{ rhsso_openshift_master_config_path }} | grep 'GENERATED BY SSO INSTALLER' | wc -l"
  register: output

- debug: var=output.stdout

-
  name: "rewrite master config and restart API"
  when: output.stdout != "0"
  block:
    -
      name: Remove RH-SSO identity provider from master config
      shell: "sed -i.bak '/# BEGIN GENERATED BY SSO INSTALLER/,/# END GENERATED BY SSO INSTALLER/d' {{ rhsso_openshift_master_config_path }}"
      become: yes

    -
      name: Read master-config to check
      command: cat "{{ rhsso_openshift_master_config_path }}"
      become: yes
      register: master_config_raw

    - debug: var=master_config_raw.stdout

    -
      name: Add htpasswd identity provider to master config
      blockinfile:
        marker: "# {mark} GENERATED BY SSO UNINSTALLER"
        path: "{{ rhsso_openshift_master_config_path }}"
        insertafter: "identityProviders"
        backup: yes
        block: |2
            - challenge: true
              name: htpasswd_auth
              login: true
              mappingMethod: claim
              provider:
                apiVersion: v1
                file: /etc/origin/master/htpasswd
                kind: HTPasswdPasswordIdentityProvider
      register: sso_master_config_update
      become: yes
      when: '"GENERATED BY SSO UNINSTALLER" not in master_config_raw.stdout'

    -
      name: Restart master api
      become: true
      shell: /usr/local/bin/master-restart api
    -
      name: Restart master controllers
      become: true
      shell: /usr/local/bin/master-restart controllers
